const IOBASE_VIRT=0o160000,IOBASE_18BIT=0o760000,IOBASE_UNIBUS=0o17000000,IOBASE_22BIT=0o17760000,MAX_MEMORY=IOBASE_UNIBUS-16384,MMU_READ=16,MMU_WRITE=32,MMU_LENGTH_MASK=0xf,MMU_BYTE=1,MMU_WORD=2,MMU_BYTE_READ=MMU_READ|MMU_BYTE,MMU_WORD_READ=MMU_READ|MMU_WORD,MMU_BYTE_WRITE=MMU_WRITE|MMU_BYTE,MMU_WORD_WRITE=MMU_WRITE|MMU_WORD,MMU_BYTE_MODIFY=MMU_READ|MMU_WRITE|MMU_BYTE,MMU_WORD_MODIFY=MMU_READ|MMU_WRITE|MMU_WORD,STATE_RUN=0,STATE_RESET=1,STATE_WAIT=2,STATE_HALT=3;var CPU={controlReg:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],CPU_Error:0,cpuType:70,displayAddress:0,displayPhysical:0,displayRegister:0,displayDataPaths:0,statusLights:0x3000,flagC:0x10000,flagN:0x8000,flagV:0x8000,flagZ:0xffff,loopBase:100,memory:[],modifyRegister:-1,modifyAddress:-1,MMR0:0,MMR1:0,MMR2:0,MMR3:0,MMR3Mask:[7,7,7,7],mmuEnable:0,mmuLastPage:0,mmuMode:0,mmuPAR:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],mmuPDR:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],PIR:0,priorityReview:1,PSW:0xf,registerAlt:[0,0,0,0,0,0],registerVal:[0,0,0,0,0,0,0,0],stackLimit:0xff,stackPointer:[0,0,0,0],switchRegister:0,trapMask:0,trapPSW:-1,unibusMap:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],runState:STATE_HALT,interruptQueue:[],};function LOG_INSTRUCTION(instruction,format,name){console.log((CPU.registerVal[7]-2).toString(8)+" "+instruction.toString(8)+" "+name)}function interrupt(delay,priority,vector,unit,callback,callarg){"use strict";var i;if(typeof callback==="undefined"){callback=null}for(i=CPU.interruptQueue.length;i-->0;){if(CPU.interruptQueue[i].vector===vector&&(unit<0||CPU.interruptQueue[i].unit===unit)){if(i>0){CPU.interruptQueue[i-1].delay+=CPU.interruptQueue[i].delay}CPU.interruptQueue.splice(i,1);break}}if(delay>=0){for(i=CPU.interruptQueue.length;i-->0;){if(CPU.interruptQueue[i].delay>delay){CPU.interruptQueue[i].delay-=delay;break}delay-=CPU.interruptQueue[i].delay}CPU.interruptQueue.splice(i+1,0,{"delay":CPU.runState===STATE_WAIT?0:delay,"priority":priority&0xe0,"vector":vector,"unit":unit<0?0:unit,"callback":callback,"callarg":callarg});if(delay>0||(priority&0xe0)>(CPU.PSW&0xe0)){CPU.priorityReview=1}if(CPU.runState===STATE_WAIT){CPU.runState=STATE_RUN;emulate(1)}}}function interruptWaitRelease(){"use strict";var savePSW,i;savePSW=CPU.PSW&0xe0;for(i=CPU.interruptQueue.length;i-->0;){CPU.interruptQueue[i].delay=0;if(CPU.interruptQueue[i].priority>(CPU.PSW&0xe0)){CPU.priorityReview=1;return 1}}return 0}function interruptReview(){"use strict";var highPriority,high,i,activeFlag;CPU.priorityReview=0;high=-1;highPriority=CPU.PIR&0xe0;for(i=CPU.interruptQueue.length;i-->0;){if(CPU.interruptQueue[i].delay>0){CPU.interruptQueue[i].delay--;CPU.priorityReview=1;break}if(CPU.interruptQueue[i].callback){if(CPU.interruptQueue[i].delay<0){if(!activeFlag){CPU.interruptQueue.splice(i,1);high--;continue}CPU.interruptQueue[i].delay=0;CPU.interruptQueue[i].callback=null}else{CPU.interruptQueue[i].delay=-1;activeFlag=CPU.interruptQueue[i].callback(CPU.interruptQueue[i].callarg);high=-1;highPriority=CPU.PIR&0xe0;i=CPU.interruptQueue.length;continue}}if(CPU.interruptQueue[i].priority>highPriority){highPriority=CPU.interruptQueue[i].priority&0xe0;high=i}}if(highPriority>(CPU.PSW&0xe0)){if(high<0){trap(0xa0,42)}else{trap(CPU.interruptQueue[high].vector,44);CPU.interruptQueue.splice(high,1)}}}function writePSW(newPSW){"use strict";var i,temp;newPSW&=0xf8ff;if((newPSW^CPU.PSW)&0x0800){for(i=0;i<=5;i++){temp=CPU.registerVal[i];CPU.registerVal[i]=CPU.registerAlt[i];CPU.registerAlt[i]=temp}}CPU.mmuMode=newPSW>>>14;if((newPSW^CPU.PSW)&0xc000){CPU.stackPointer[(CPU.PSW>>>14)&3]=CPU.registerVal[6];CPU.registerVal[6]=CPU.stackPointer[CPU.mmuMode]}if((newPSW&0xe0)<(CPU.PSW&0xe0)){CPU.priorityReview=1}CPU.PSW=newPSW;CPU.flagN=newPSW<<12;CPU.flagZ=(~newPSW)&4;CPU.flagV=newPSW<<14;CPU.flagC=newPSW<<16}function readPSW(){"use strict";var flags=0;if(testN()){flags|=8}if(testZ()){flags|=4}if(testV()){flags|=2}if(testC()){flags|=1}return(CPU.PSW=(CPU.PSW&0xf8f0)|flags)}function setFlags(mask,value){"use strict";if(mask&8){CPU.flagN=value<<12}if(mask&4){CPU.flagZ=(~value)&4}if(mask&2){CPU.flagV=value<<14}if(mask&1){CPU.flagC=value<<16}}function zeroNZVC(){"use strict";CPU.flagN=CPU.flagZ=CPU.flagV=CPU.flagC=0}function setNZ(result){"use strict";CPU.flagN=CPU.flagZ=result;CPU.flagV=0}function setNZV(result,flagV){"use strict";CPU.flagN=CPU.flagZ=result;CPU.flagV=flagV}function setNZC(result){"use strict";CPU.flagN=CPU.flagZ=CPU.flagC=result;CPU.flagV=0}function setNZVC(result,flagV){"use strict";CPU.flagN=CPU.flagZ=CPU.flagC=result;CPU.flagV=flagV}function setByteNZ(result){"use strict";CPU.flagN=CPU.flagZ=result<<8;CPU.flagV=0}function setByteNZV(result,flagV){"use strict";CPU.flagN=CPU.flagZ=result<<8;CPU.flagV=flagV<<8}function setByteNZC(result){"use strict";CPU.flagN=CPU.flagZ=CPU.flagC=result<<8;CPU.flagV=0}function setByteNZVC(result,flagV){"use strict";CPU.flagN=CPU.flagZ=CPU.flagC=result<<8;CPU.flagV=flagV<<8}function testN(){"use strict";return CPU.flagN&0x8000}function testZ(){"use strict";return!(CPU.flagZ&0xffff)}function testV(){"use strict";return CPU.flagV&0x8000}function testC(){"use strict";return CPU.flagC&0x10000}function logicalXOR(a,b){"use strict";if(!a){return b}else{return!b}}function trap(vector,reason){"use strict";var newPC,newPSW,doubleTrap=0;if(CPU.trapPSW>-2){if(CPU.trapPSW<0){CPU.trapMask=0;CPU.trapPSW=readPSW()}else{if(!CPU.mmuMode){vector=4;doubleTrap=1}}if(!(CPU.MMR0&0xe000)){CPU.MMR1=0xf6f6;CPU.MMR2=vector}CPU.mmuMode=0;if((newPC=readWordByVirtual(vector|0x10000))>=0){if((newPSW=readWordByVirtual(((vector+2)&0xffff)|0x10000))>=0){writePSW((newPSW&0xcfff)|((CPU.trapPSW>>>2)&0x3000));if(doubleTrap){CPU.CPU_Error|=4;CPU.registerVal[6]=4}if(pushWord(CPU.trapPSW,doubleTrap)>=0&&pushWord(CPU.registerVal[7],doubleTrap)>=0){CPU.registerVal[7]=newPC}}}CPU.trapPSW=-1}return-1}function readWordByPhysical(physicalAddress){"use strict";var data;if(physicalAddress<IOBASE_UNIBUS){data=CPU.memory[physicalAddress>>>1]}else{data=access_iopage(physicalAddress,-1,0)}return data}function writeWordByPhysical(physicalAddress,data){"use strict";if(physicalAddress<IOBASE_UNIBUS){CPU.memory[physicalAddress>>>1]=data}else{return access_iopage(physicalAddress,data,0)}return 0}function readByteByPhysical(physicalAddress){"use strict";var data;if(physicalAddress<IOBASE_UNIBUS){if(physicalAddress&1){data=CPU.memory[physicalAddress>>>1]>>>8}else{data=CPU.memory[physicalAddress>>>1]&0xff}}else{data=access_iopage(physicalAddress,-1,1)}return data}function writeByteByPhysical(physicalAddress,data){"use strict";var memoryIndex;if(physicalAddress<IOBASE_UNIBUS){memoryIndex=physicalAddress>>>1;if(physicalAddress&1){CPU.memory[memoryIndex]=(data<<8)|(CPU.memory[memoryIndex]&0xff)}else{CPU.memory[memoryIndex]=(CPU.memory[memoryIndex]&0xff00)|data}}else{return access_iopage(physicalAddress,data,1)}return 0}function mapVirtualToPhysical(virtualAddress,accessMask){"use strict";var page,pdr,physicalAddress,errorMask;CPU.displayAddress=virtualAddress&0xffff;if(!(accessMask&CPU.mmuEnable)){physicalAddress=virtualAddress&0xffff;CPU.mmuLastPage=0;if(physicalAddress>=IOBASE_VIRT){physicalAddress|=IOBASE_22BIT}else{if((physicalAddress&1)&&!(accessMask&MMU_BYTE)){CPU.displayPhysical=-1;CPU.CPU_Error|=0x40;return trap(4,22)}}}else{page=(CPU.mmuMode<<4)|((virtualAddress>>>13)&CPU.MMR3Mask[CPU.mmuMode]);physicalAddress=((CPU.mmuPAR[page]<<6)+(virtualAddress&0x1fff))&0x3fffff;if(!(CPU.MMR3&0x10)){physicalAddress&=0x3ffff;if(physicalAddress>=IOBASE_18BIT){physicalAddress|=IOBASE_22BIT}}if(physicalAddress<MAX_MEMORY){if((physicalAddress&1)&&!(accessMask&MMU_BYTE)){CPU.displayPhysical=-1;CPU.CPU_Error|=0x40;return trap(4,26)}CPU.mmuLastPage=page}else{if(physicalAddress<IOBASE_22BIT){if(physicalAddress>=IOBASE_UNIBUS){physicalAddress=mapUnibus(physicalAddress&0x3ffff);if(physicalAddress>=MAX_MEMORY&&physicalAddress<IOBASE_22BIT){CPU.displayPhysical=-1;CPU.CPU_Error|=0x10;return trap(4,24)}}else{CPU.displayPhysical=-1;CPU.CPU_Error|=0x20;return trap(4,24)}}if(CPU.mmuMode||(physicalAddress!==0x3fff7a)){CPU.mmuLastPage=page}}errorMask=0;pdr=CPU.mmuPDR[page];switch(pdr&0x7){case 1:errorMask=0x1000;case 2:CPU.mmuPDR[page]|=0x80;if(accessMask&MMU_WRITE){errorMask=0x2000}break;case 4:errorMask=0x1000;case 5:if(accessMask&MMU_WRITE){errorMask=0x1000}case 6:CPU.mmuPDR[page]|=((accessMask&MMU_WRITE)?0xc0:0x80);break;default:errorMask=0x8000;break}if(pdr&0x8){if((pdr&=0x7f00)){if(((virtualAddress<<2)&0x7f00)<pdr){errorMask|=0x4000}}}else{if((pdr&=0x7f00)!==0x7f00){if(((virtualAddress<<2)&0x7f00)>pdr){errorMask|=0x4000}}}if(errorMask){if(errorMask&0xe000){if(CPU.trapPSW>=0){errorMask|=0x80}if(!(CPU.MMR0&0xe000)){CPU.MMR0|=errorMask|(CPU.mmuLastPage<<1)}CPU.displayPhysical=-1;return trap(0xa8,28)}if(!(CPU.MMR0&0xf000)){if(physicalAddress<0x3ff480||physicalAddress>0x3fffbf){CPU.MMR0|=0x1000;if(CPU.MMR0&0x0200){CPU.trapMask|=2}}}}}return(CPU.displayPhysical=physicalAddress)}function readWordByVirtual(virtualAddress){"use strict";var physicalAddress;if((physicalAddress=mapVirtualToPhysical(virtualAddress,MMU_WORD_READ))<0){return physicalAddress}return readWordByPhysical(physicalAddress)}function writeWordByVirtual(virtualAddress,data){"use strict";var physicalAddress;if((physicalAddress=mapVirtualToPhysical(virtualAddress,MMU_WORD_WRITE))<0){return physicalAddress}return writeWordByPhysical(physicalAddress,data)}function stackCheck(virtualAddress){"use strict";if(!CPU.mmuMode){if(virtualAddress<=CPU.stackLimit||virtualAddress>=0xfffe){if(virtualAddress+32<=CPU.stackLimit||virtualAddress>=0xfffe){CPU.displayPhysical=-1;CPU.CPU_Error|=4;CPU.registerVal[6]=4;return trap(4,38)}CPU.CPU_Error|=8;CPU.trapMask|=4}}return virtualAddress}function pushWord(data,skipLimitCheck){"use strict";var virtualAddress;virtualAddress=CPU.registerVal[6]=(CPU.registerVal[6]-2)&0xffff;if(!(CPU.MMR0&0xe000)){CPU.MMR1=(CPU.MMR1<<8)|0xf6}if(!skipLimitCheck){if((virtualAddress=stackCheck(virtualAddress))<0){return virtualAddress}}return writeWordByVirtual(virtualAddress|0x10000,data)}function popWord(){"use strict";var data;if((data=readWordByVirtual(CPU.registerVal[6]|0x10000))>=0){CPU.registerVal[6]=(CPU.registerVal[6]+2)&0xffff}return data}function getVirtualByMode(addressMode,accessMode){"use strict";var virtualAddress,autoIncrement,reg=addressMode&7;switch((addressMode>>>3)&7){case 0:return trap(4,34);case 1:virtualAddress=CPU.registerVal[reg];if(reg!==7){if(reg===6){if(accessMode&MMU_WRITE){if((virtualAddress=stackCheck(virtualAddress))<0){return virtualAddress}}}virtualAddress|=0x10000}return virtualAddress;case 2:autoIncrement=accessMode&MMU_LENGTH_MASK;virtualAddress=CPU.registerVal[reg];if(reg<6){virtualAddress|=0x10000}else{if(reg===6){if(accessMode&MMU_BYTE){autoIncrement=2}if(accessMode&MMU_WRITE){if((virtualAddress=stackCheck(virtualAddress))<0){return virtualAddress}}virtualAddress|=0x10000}else{autoIncrement=2}}break;case 3:autoIncrement=2;virtualAddress=CPU.registerVal[reg];if(reg!==7){virtualAddress|=0x10000}if((virtualAddress=readWordByVirtual(virtualAddress))<0){return virtualAddress}virtualAddress|=0x10000;break;case 4:autoIncrement=-(accessMode&MMU_LENGTH_MASK);if(reg<6){virtualAddress=((CPU.registerVal[reg]+autoIncrement)&0xffff)|0x10000}else{if((accessMode&MMU_BYTE)||reg===7){autoIncrement=-2}virtualAddress=(CPU.registerVal[reg]+autoIncrement)&0xffff;if(reg===6){if(accessMode&MMU_WRITE){if((virtualAddress=stackCheck(virtualAddress))<0){return virtualAddress}}virtualAddress|=0x10000}}break;case 5:autoIncrement=-2;virtualAddress=(CPU.registerVal[reg]-2)&0xffff;if(reg!==7){virtualAddress|=0x10000}if((virtualAddress=readWordByVirtual(virtualAddress))<0){return virtualAddress}virtualAddress|=0x10000;break;case 6:if((virtualAddress=readWordByVirtual(CPU.registerVal[7]))<0){return virtualAddress}CPU.registerVal[7]=(CPU.registerVal[7]+2)&0xffff;virtualAddress=(virtualAddress+CPU.registerVal[reg])&0xffff;if(reg===6&&(accessMode&MMU_WRITE)){if((virtualAddress=stackCheck(virtualAddress))<0){return virtualAddress}}return virtualAddress|0x10000;default:if((virtualAddress=readWordByVirtual(CPU.registerVal[7]))<0){return virtualAddress}CPU.registerVal[7]=(CPU.registerVal[7]+2)&0xffff;virtualAddress=(virtualAddress+CPU.registerVal[reg])&0xffff;if((virtualAddress=readWordByVirtual(virtualAddress|0x10000))<0){return virtualAddress}return virtualAddress|0x10000}CPU.registerVal[reg]=(CPU.registerVal[reg]+autoIncrement)&0xffff;if(!(CPU.MMR0&0xe000)){CPU.MMR1=(CPU.MMR1<<8)|((autoIncrement<<3)&0xf8)|reg}return virtualAddress}function mapPhysicalByMode(addressMode,accessMode){"use strict";var virtualAddress;if((virtualAddress=getVirtualByMode(addressMode,accessMode))<0){return virtualAddress}return mapVirtualToPhysical(virtualAddress,accessMode)}function readWordByMode(addressMode){"use strict";var data,physicalAddress;if(!(addressMode&0x38)){data=CPU.registerVal[addressMode&7]}else{if((physicalAddress=mapPhysicalByMode(addressMode,MMU_WORD_READ))<0){return physicalAddress}data=readWordByPhysical(physicalAddress)}return data}function writeWordByMode(addressMode,data){"use strict";data&=0xffff;var physicalAddress;if(!(addressMode&0x38)){CPU.registerVal[addressMode&7]=data}else{if((physicalAddress=mapPhysicalByMode(addressMode,MMU_WORD_WRITE))<0){return physicalAddress}return writeWordByPhysical(physicalAddress,data)}return 0}function modifyWordByMode(addressMode){"use strict";var data,physicalAddress;if(!(addressMode&0x38)){CPU.modifyRegister=addressMode&7;data=CPU.registerVal[CPU.modifyRegister]}else{if((physicalAddress=mapPhysicalByMode(addressMode,MMU_WORD_MODIFY))<0){return physicalAddress}CPU.modifyRegister=-1;CPU.modifyAddress=physicalAddress;data=readWordByPhysical(physicalAddress)}return data}function modifyWord(data){"use strict";data&=0xffff;if(CPU.modifyRegister>=0){CPU.registerVal[CPU.modifyRegister]=data}else{return writeWordByPhysical(CPU.modifyAddress,data)}return 0}function readByteByMode(addressMode){"use strict";var data,physicalAddress;if(!(addressMode&0x38)){data=CPU.registerVal[addressMode&7]&0xff}else{if((physicalAddress=mapPhysicalByMode(addressMode,MMU_BYTE_READ))<0){return physicalAddress}data=readByteByPhysical(physicalAddress)}return data}function writeByteByMode(addressMode,data){"use strict";var physicalAddress;data&=0xff;if(!(addressMode&0x38)){CPU.registerVal[addressMode&7]=(CPU.registerVal[addressMode&7]&0xff00)|data}else{if((physicalAddress=mapPhysicalByMode(addressMode,MMU_BYTE_WRITE))<0){return physicalAddress}return writeByteByPhysical(physicalAddress,data)}return 0}function modifyByteByMode(addressMode){"use strict";var data,physicalAddress;if(!(addressMode&0x38)){CPU.modifyRegister=addressMode&7;data=CPU.registerVal[CPU.modifyRegister]&0xff}else{if((physicalAddress=mapPhysicalByMode(addressMode,MMU_BYTE_MODIFY))<0){return physicalAddress}CPU.modifyRegister=-1;CPU.modifyAddress=physicalAddress;data=readByteByPhysical(physicalAddress)}return data}function modifyByte(data){"use strict";data&=0xff;if(CPU.modifyRegister>=0){CPU.registerVal[CPU.modifyRegister]=(CPU.registerVal[CPU.modifyRegister]&0xff00)|data}else{return writeByteByPhysical(CPU.modifyAddress,data)}return 0}function branch(instruction){"use strict";CPU.registerVal[7]=(CPU.registerVal[7]+((instruction&0x80?instruction|0xff00:instruction&0xff)<<1))&0xffff}function emulate(){"use strict";var instruction,src,dst,result=0,virtualAddress,savePSW,reg;var loopCount,loopTime;var CPU=window.CPU;if(CPU.runState===STATE_RUN){loopTime=Date.now();loopCount=CPU.loopBase}else{loopTime=loopCount=0;if(CPU.runState!==STATE_HALT){return}}do{if(CPU.priorityReview){if(!(--CPU.priorityReview)){interruptReview()}}if(CPU.trapMask){if(CPU.trapMask&2){trap(0o250,52)}else{if(CPU.trapMask&4){trap(0o4,54)}else{if(CPU.trapMask&8){trap(0o244,55)}else{if(CPU.trapMask&0x10){trap(0o14,56)}}}}}if(!(CPU.MMR0&0xe000)){CPU.MMR1=0;CPU.MMR2=CPU.registerVal[7]}CPU.trapMask=CPU.PSW&0x10;if((instruction=readWordByVirtual(CPU.registerVal[7]))>=0){CPU.registerVal[7]=(CPU.registerVal[7]+2)&0xffff;switch(instruction>>>12){case 0:switch(instruction>>8){case 0:switch(instruction>>>6){case 0:switch(instruction){case 0:if(CPU.mmuMode){CPU.CPU_Error|=0o200;trap(4,46)}else{CPU.runState=STATE_HALT;loopCount=0;console.log("HALT at "+CPU.registerVal[7].toString(8)+" PSW: "+readPSW().toString(8))}break;case 1:if(!interruptWaitRelease()){if(CPU.runState!==STATE_HALT){CPU.runState=STATE_WAIT}loopCount=0}break;case 3:trap(0o14,6);break;case 4:trap(0o20,8);break;case 5:if(!CPU.mmuMode){reset_iopage();if(CPU.runState!==STATE_HALT){CPU.runState=STATE_RESET}loopCount=0}break;case 2:case 6:if((result=popWord())>=0){if((savePSW=popWord())>=0){savePSW&=0xf8ff;if(CPU.mmuMode){savePSW=(savePSW&0xf81f)|(CPU.PSW&0xf8e0)}CPU.registerVal[7]=result;writePSW(savePSW);CPU.trapMask&=~0x10;if(instruction===2){CPU.trapMask|=CPU.PSW&0x10}}}break;default:trap(0o10,48);break}break;case 1:if((virtualAddress=getVirtualByMode(instruction,MMU_WORD))>=0){CPU.registerVal[7]=virtualAddress&0xffff}break;case 2:switch((instruction>>>3)&7){case 0:if((result=popWord())>=0){reg=instruction&7;CPU.registerVal[7]=CPU.registerVal[reg];CPU.registerVal[reg]=result}break;case 3:if(!CPU.mmuMode){CPU.PSW=(CPU.PSW&0xf81f)|((instruction&7)<<5);CPU.priorityReview=2}break;case 4:case 5:setFlags(instruction&0xf,0);break;case 6:case 7:setFlags(instruction&0xf,0xf);break;default:trap(0o10,48);break}break;case 3:if((dst=modifyWordByMode(instruction))>=0){result=(dst<<8)|(dst>>>8);if(modifyWord(result)>=0){setNZC(dst&0xff00)}}break}break;case 1:branch(instruction);break;case 2:if(!testZ()){branch(instruction)}break;case 3:if(testZ()){branch(instruction)}break;case 4:if(!logicalXOR(testN(),testV())){branch(instruction)}break;case 5:if(logicalXOR(testN(),testV())){branch(instruction)}break;case 6:if(!testZ()&&!logicalXOR(testN(),testV())){branch(instruction)}break;case 7:if(testZ()||logicalXOR(testN(),testV())){branch(instruction)}break;case 8:case 9:if((virtualAddress=getVirtualByMode(instruction,MMU_WORD))>=0){reg=(instruction>>>6)&7;if(pushWord(CPU.registerVal[reg],0)>=0){CPU.registerVal[reg]=CPU.registerVal[7];CPU.registerVal[7]=virtualAddress&0xffff}}break;default:switch(instruction>>>6){case 0o50:if(writeWordByMode(instruction,0)>=0){zeroNZVC()}break;case 0o51:if((dst=modifyWordByMode(instruction))>=0){result=~dst;if(modifyWord(result)>=0){setNZC(result)}}break;case 0o52:if((dst=modifyWordByMode(instruction))>=0){result=dst+1;if(modifyWord(result)>=0){setNZV(result,result&(result^dst))}}break;case 0o53:if((dst=modifyWordByMode(instruction))>=0){result=dst+0xffff;if(modifyWord(result)>=0){setNZV(result,(result^dst)&dst)}}break;case 0o54:if((dst=modifyWordByMode(instruction))>=0){result=-dst;if(modifyWord(result)>=0){setNZVC(result,result&dst)}}break;case 0o55:if((dst=modifyWordByMode(instruction))>=0){result=dst;if(testC()){result++}if(modifyWord(result)>=0){setNZVC(result,result&(result^dst))}}break;case 0o56:if((dst=modifyWordByMode(instruction))>=0){result=dst;if(testC()){result--}if(modifyWord(result)>=0){setNZVC(result,(result^dst)&dst)}}break;case 0o57:if((result=readWordByMode(instruction))>=0){setNZC(result)}break;case 0o60:if((dst=modifyWordByMode(instruction))>=0){result=(dst<<16)|(dst>>>1);if(testC()){result|=0x8000}if(modifyWord(result)>=0){setNZVC(result,result^(result>>>1))}}break;case 0o61:if((dst=modifyWordByMode(instruction))>=0){result=dst<<1;if(testC()){result|=1}if(modifyWord(result)>=0){setNZVC(result,result^dst)}}break;case 0o62:if((dst=modifyWordByMode(instruction))>=0){result=(dst<<16)|(dst&0x8000)|(dst>>>1);if(modifyWord(result)>=0){setNZVC(result,result^(result>>>1))}}break;case 0o63:if((dst=modifyWordByMode(instruction))>=0){result=dst<<1;if(modifyWord(result)>=0){setNZVC(result,result^dst)}}break;case 0o64:virtualAddress=(CPU.registerVal[7]+((instruction&0o77)<<1))&0xffff;if((result=readWordByVirtual(virtualAddress|0x10000))>=0){CPU.registerVal[7]=CPU.registerVal[5];CPU.registerVal[5]=result;CPU.registerVal[6]=(virtualAddress+2)&0xffff}break;case 0o65:if(!(instruction&0x38)){reg=instruction&7;if(reg!==6||((CPU.PSW>>>12)&3)===CPU.mmuMode){result=CPU.registerVal[reg]}else{result=CPU.stackPointer[(CPU.PSW>>>12)&3]}if(pushWord(result,0)>=0){setNZ(result)}}else{if((virtualAddress=getVirtualByMode(instruction,MMU_WORD))>=0){if((CPU.PSW&0xf000)!==0xf000){virtualAddress&=0xffff}CPU.mmuMode=(CPU.PSW>>>12)&3;if((result=readWordByVirtual(virtualAddress))>=0){CPU.mmuMode=(CPU.PSW>>>14)&3;if(pushWord(result,0)>=0){setNZ(result)}}}}break;case 0o66:if((result=popWord())>=0){if(!(CPU.MMR0&0xe000)){CPU.MMR1=0o26}if(!(instruction&0x38)){reg=instruction&7;if(reg!==6||((CPU.PSW>>>12)&3)===CPU.mmuMode){CPU.registerVal[reg]=result}else{CPU.stackPointer[(CPU.PSW>>>12)&3]=result}setNZ(result)}else{if((virtualAddress=getVirtualByMode(instruction,MMU_WORD))>=0){CPU.mmuMode=(CPU.PSW>>>12)&3;if(writeWordByVirtual(virtualAddress&0xffff,result)>=0){CPU.mmuMode=(CPU.PSW>>>14)&3;setNZ(result)}}}}break;case 0o67:result=0;if(testN()){result=0xffff}if(writeWordByMode(instruction,result)>=0){setNZ(result)}break;default:trap(0o10,48);break}}break;case 1:if((result=readWordByMode(instruction>>>6))>=0){if(writeWordByMode(instruction,result)>=0){setNZ(result)}}break;case 2:if((src=readWordByMode(instruction>>>6))>=0){if((dst=readWordByMode(instruction))>=0){result=src-dst;setNZVC(result,(result^src)&(src^dst))}}break;case 3:if((src=readWordByMode(instruction>>>6))>=0){if((result=readWordByMode(instruction))>=0){setNZ(src&result)}}break;case 4:if((src=readWordByMode(instruction>>>6))>=0){if((dst=modifyWordByMode(instruction))>=0){result=dst&~src;if(modifyWord(result)>=0){setNZ(result)}}}break;case 5:if((src=readWordByMode(instruction>>>6))>=0){if((dst=modifyWordByMode(instruction))>=0){result=dst|src;if(modifyWord(result)>=0){setNZ(result)}}}break;case 6:if((src=readWordByMode(instruction>>>6))>=0){if((dst=modifyWordByMode(instruction))>=0){result=src+dst;if(modifyWord(result)>=0){setNZVC(result,(result^src)&(result^dst))}}}break;case 7:switch((instruction>>>9)&7){case 0:if((src=readWordByMode(instruction))>=0){reg=(instruction>>>6)&7;dst=CPU.registerVal[reg];if(src&0x8000){src-=0x10000}if(dst&0x8000){dst-=0x10000}result=src*dst;CPU.registerVal[reg]=(result>>>16)&0xffff;CPU.registerVal[reg|1]=result&0xffff;result=(result>>>16)|((result&0xffff)?1:0)|((result<-32768||result>32767)?0x10000:0);setNZC(result)}break;case 1:if((src=readWordByMode(instruction))>=0){if(!src){setNZVC(0x10000,0x8000)}else{reg=(instruction>>>6)&7;dst=(CPU.registerVal[reg]<<16)|CPU.registerVal[reg|1];if(src&0x8000){src-=0x10000}if(dst&0x80000000){dst=(dst&0x7fffffff)-0x80000000}result=~~(dst/src);if(result>=-32768&&result<=32767){CPU.registerVal[reg]=result&0xffff;CPU.registerVal[reg|1]=(dst-(result*src))&0xffff;setNZC((result>>>16)|(result?1:0))}else{setNZVC(((dst>>>16)&0x8000)|(result?1:0),0x8000);if(!(result&0x7fffffff))setFlags(4,4);if(src===-1&&CPU.registerVal[reg]===0xfffe){CPU.registerVal[reg]=CPU.registerVal[reg|1]=1}}}}break;case 2:if((src=readWordByMode(instruction))>=0){reg=(instruction>>>6)&7;result=CPU.registerVal[reg];src&=0x3f;if(!(src&&result)){setNZC(result)}else{if(src&0x20){src=64-src;if(src>16){src=16}dst=result>>>(src-1);if(result&0x8000){result=((0xffff0000|result)>>>src)&0xffff}else{result>>>=src}setNZC((dst<<16)|result)}else{if(src>17){src=17}result<<=src;dst=result&0xffff8000;if(dst&&dst!==((0xffff<<src)&0xffff8000)){setNZVC(result,0x8000)}else{setNZC(result)}}CPU.registerVal[reg]=result&0xffff}}break;case 3:if((src=readWordByMode(instruction))>=0){reg=(instruction>>>6)&7;result=(CPU.registerVal[reg]<<16)|CPU.registerVal[reg|1];src&=0x3f;if(!(src&&result)){setNZC(result>>>16|(result?1:0))}else{if(src&0x20){src=64-src;dst=result>>>(src-1);if(result&0x80000000){result=(0xffffffff<<(32-src))|(result>>>src)}else{result>>>=src}setNZC((dst<<16)|(result?(result>>>16)|1:0))}else{dst=result>>>(31-src);result<<=src;if(dst&&dst!==(0xffffffff>>>(31-src))){setNZVC((dst<<15)|(result?1:0),0x8000)}else{setNZC((dst<<15)|(result?1:0))}}CPU.registerVal[reg]=(result>>>16)&0xffff;CPU.registerVal[reg|1]=result&0xffff}}break;case 4:src=CPU.registerVal[(instruction>>>6)&7];if((result=modifyWordByMode(instruction))>=0){result^=src;if(modifyWord(result)>=0){setNZ(result)}}break;case 7:reg=(instruction>>>6)&7;if((CPU.registerVal[reg]=((CPU.registerVal[reg]-1)&0xffff))){CPU.registerVal[7]=(CPU.registerVal[7]-((instruction&0o77)<<1))&0xffff}break;default:trap(0o10,48);break}break;case 8:switch((instruction>>8)&0xf){case 0:if(!testN()){branch(instruction)}break;case 1:if(testN()){branch(instruction)}break;case 2:if(!testC()&&!testZ()){branch(instruction)}break;case 3:if(testC()||testZ()){branch(instruction)}break;case 4:if(!testV()){branch(instruction)}break;case 5:if(testV()){branch(instruction)}break;case 6:if(!testC()){branch(instruction)}break;case 7:if(testC()){branch(instruction)}break;case 8:trap(0o30,2);break;case 9:trap(0o34,4);break;default:switch((instruction>>>6)&0o77){case 0o50:if(writeByteByMode(instruction,0)>=0){zeroNZVC()}break;case 0o51:if((dst=modifyByteByMode(instruction))>=0){result=~dst;if(modifyByte(result)>=0){setByteNZC(result)}}break;case 0o52:if((dst=modifyByteByMode(instruction))>=0){result=dst+1;if(modifyByte(result)>=0){setByteNZV(result,result&(result^dst))}}break;case 0o53:if((dst=modifyByteByMode(instruction))>=0){result=dst+0xffff;if(modifyByte(result)>=0){setByteNZV(result,(result^dst)&dst)}}break;case 0o54:if((dst=modifyByteByMode(instruction))>=0){result=-dst;if(modifyByte(result)>=0){setByteNZVC(result,result&dst)}}break;case 0o55:if((dst=modifyByteByMode(instruction))>=0){result=dst;if(testC()){result++}if(modifyByte(result)>=0){setByteNZVC(result,result&(result^dst))}}break;case 0o56:if((dst=modifyByteByMode(instruction))>=0){result=dst;if(testC()){result--}if(modifyByte(result)>=0){setByteNZVC(result,(result^dst)&dst)}}break;case 0o57:if((result=readByteByMode(instruction))>=0){setByteNZC(result)}break;case 0o60:if((dst=modifyByteByMode(instruction))>=0){result=(dst<<8)|(dst>>>1);if(testC()){result|=0x80}if(modifyByte(result)>=0){setByteNZVC(result,result^(result>>1))}}break;case 0o61:if((dst=modifyByteByMode(instruction))>=0){result=dst<<1;if(testC()){result|=1}if(modifyByte(result)>=0){setByteNZVC(result,result^dst)}}break;case 0o62:if((dst=modifyByteByMode(instruction))>=0){result=(dst<<8)|(dst&0x80)|(dst>>>1);if(modifyByte(result)>=0){setByteNZVC(result,result^(result>>>1))}}break;case 0o63:if((dst=modifyByteByMode(instruction))>=0){result=dst<<1;if(modifyByte(result)>=0){setByteNZVC(result,result^dst)}}break;case 0o65:if(!(instruction&0x38)){reg=instruction&7;if(reg!==6||((CPU.PSW>>>12)&3)===CPU.mmuMode){result=CPU.registerVal[reg]}else{result=CPU.stackPointer[(CPU.PSW>>>12)&3]}if(pushWord(result,0)>=0){setNZ(result)}}else{if((virtualAddress=getVirtualByMode(instruction,MMU_WORD))>=0){CPU.mmuMode=(CPU.PSW>>>12)&3;if((result=readWordByVirtual(virtualAddress|0x10000))>=0){CPU.mmuMode=(CPU.PSW>>>14)&3;if(pushWord(result,0)>=0){setNZ(result)}}}}break;case 0o66:if((result=popWord())>=0){if(!(CPU.MMR0&0xe000)){CPU.MMR1=0o26}if(!(instruction&0x38)){reg=instruction&7;if(reg!==6||((CPU.PSW>>>12)&3)===CPU.mmuMode){CPU.registerVal[reg]=result}else{CPU.stackPointer[(CPU.PSW>>>12)&3]=result}setNZ(result)}else{if((virtualAddress=getVirtualByMode(instruction,MMU_WORD))>=0){CPU.mmuMode=(CPU.PSW>>>12)&3;if(writeWordByVirtual(virtualAddress|0x10000,result)>=0){CPU.mmuMode=(CPU.PSW>>>14)&3;setNZ(result)}}}}break;default:trap(0o10,48);break}break}break;case 9:if((result=readByteByMode(instruction>>>6))>=0){if(!(instruction&0x38)){if(result&0o200){result|=0xff00}CPU.registerVal[instruction&7]=result;setByteNZ(result)}else{if(writeByteByMode(instruction,result)>=0){setByteNZ(result)}}}break;case 10:if((src=readByteByMode(instruction>>>6))>=0){if((dst=readByteByMode(instruction))>=0){result=src-dst;setByteNZVC(result,(result^src)&(src^dst))}}break;case 11:if((src=readByteByMode(instruction>>>6))>=0){if((result=readByteByMode(instruction))>=0){setByteNZ(src&result)}}break;case 12:if((src=readByteByMode(instruction>>>6))>=0){if((dst=modifyByteByMode(instruction))>=0){result=dst&~src;if(modifyByte(result)>=0){setByteNZ(result)}}}break;case 13:if((src=readByteByMode(instruction>>>6))>=0){if((dst=modifyByteByMode(instruction))>=0){result=dst|src;if(modifyByte(result)>=0){setByteNZ(result)}}}break;case 14:if((src=readWordByMode(instruction>>>6))>=0){if((dst=modifyWordByMode(instruction))>=0){result=dst-src;if(modifyWord(result)>=0){setNZVC(result,(result^dst)&(src^dst))}}}break;default:if(typeof executeFPP!=='undefined'){executeFPP(instruction)}else{trap(0o10,48)}break}}}while(--loopCount>0);if(loopCount===0){src=Date.now()-loopTime-8;if(src>0){CPU.loopBase=Math.max(20,CPU.loopBase-src*32)}else{if(src<0){CPU.loopBase-=src*33}}}if(CPU.runState===STATE_RUN){CPU.displayDataPaths=result&0xffff;setTimeout(emulate,0)}else{CPU.displayDataPaths=CPU.registerVal[0];CPU.displayAddress=CPU.registerVal[7];if(CPU.runState===STATE_RESET){CPU.runState=STATE_RUN;setTimeout(emulate,60)}}}var panel={addressLights:0x3fffff,displayLights:0xffff,statusLights:0x3ffffff,addressId:[],displayId:[],statusId:[],LIGHTS_STATE:[0x280,0x300,0x100,0x80],LIGHTS_MODE:[0x10,0x20,0,0x40],rotary1:0,rotary0:0,powerSwitch:0,halt:0,step:0,lampTest:0,autoIncr:0};function initPanel(idName,idCount){"use strict";var id,idArray=[];for(id=0;id<idCount;id++){idArray[id]=document.getElementById(idName+id)}return idArray}function updateLights(){"use strict";var addressLights,displayLights,statusLights;function updatePanel(oldMask,newMask,idArray){var id=0,mask=oldMask^newMask;while(mask){while(!(mask&1)){mask>>=1;id++}if(idArray[id]){idArray[id].style.visibility=((newMask&(1<<id))?'visible':'hidden')}mask>>=1;id++}}if(panel.powerSwitch<0){addressLights=0;displayLights=0;statusLights=0}else{if(panel.lampTest){addressLights=0x3fffff;displayLights=0xffff;statusLights=0x3ffffff}else{if(panel.rotary0!==1){addressLights=CPU.displayAddress}else{addressLights=0;if(CPU.displayPhysical>=0){addressLights=CPU.displayPhysical}}switch(panel.rotary1){case 0:case 1:displayLights=CPU.displayDataPaths;break;case 2:displayLights=CPU.switchRegister;break;case 3:displayLights=CPU.displayRegister;break}statusLights=(0x400000<<panel.rotary1)|(0x4000<<panel.rotary0)|0x3000|(CPU.displayPhysical<0?0x400:0)|(CPU.mmuLastPage&8)|panel.LIGHTS_STATE[CPU.runState]|panel.LIGHTS_MODE[CPU.mmuMode]|((CPU.mmuEnable)?(CPU.MMR3&0x10)?1:2:4)}}if(addressLights!==panel.addressLights){updatePanel(panel.addressLights,addressLights,panel.addressId);panel.addressLights=addressLights}if(displayLights!==panel.displayLights){updatePanel(panel.displayLights,displayLights,panel.displayId);panel.displayLights=displayLights}if(statusLights!==panel.statusLights){updatePanel(panel.statusLights,statusLights,panel.statusId);panel.statusLights=statusLights}requestAnimationFrame(updateLights)}panel.addressId=initPanel("a",22);panel.displayId=initPanel("d",16);panel.statusId=initPanel("s",26);requestAnimationFrame(updateLights);function boot(){"use strict";var i;for(i=0;i<IOBASE_UNIBUS/2;i++){CPU.memory[i]=0}for(i=0;i<bootcode.length;i++){CPU.memory[(BOOTBASE>>>1)+i]=bootcode[i]}CPU.registerVal[7]=CPU.registerVal[6]=BOOTBASE;CPU.PIR=0;writePSW(0);reset_iopage();if(CPU.runState!==STATE_RUN){CPU.runState=STATE_RUN;emulate(1)}}

