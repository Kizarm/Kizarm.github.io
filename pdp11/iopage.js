const IO_BLOCKSIZE=1024*1024;function extractXHR(xhr,cache,block){"use strict";var dataView,dataLength,dataIndex,blockIndex;switch(xhr.status){case 416:dataLength=0;break;case 200:block=0;case 0:case 206:dataView=new Uint8Array(xhr.response);dataLength=dataView.length;break;default:return-1}dataIndex=0;do{if(typeof cache[block]==="undefined"){cache[block]=new Uint8Array(IO_BLOCKSIZE);for(blockIndex=0;blockIndex<IO_BLOCKSIZE&&dataIndex<dataLength;){cache[block][blockIndex++]=dataView[dataIndex++]&0xff}}else{dataIndex+=IO_BLOCKSIZE}block++}while(dataIndex<dataLength);return 0}function getData(xhr,operation,meta,position,address,count){"use strict";if(extractXHR(xhr,meta.cache,~~(position/IO_BLOCKSIZE))<0){meta.postProcess(1,meta,position,address,count)}else{diskIO(operation,meta,position,address,count)}}function diskIO(operation,meta,position,address,count){"use strict";var block,offset,data;block=~~(position/IO_BLOCKSIZE);if(typeof meta.cache[block]!=="undefined"){offset=position%IO_BLOCKSIZE;while(count>0){switch(operation){case 1:case 3:data=readWordByPhysical((meta.mapped?mapUnibus(address):address));if(data<0){meta.postProcess(2,meta,block*IO_BLOCKSIZE+offset,address,count);return}if(operation===1){meta.cache[block][offset]=data&0xff;meta.cache[block][offset+1]=(data>>>8)&0xff}else{if(data!==((meta.cache[block][offset+1]<<8)|meta.cache[block][offset])){meta.postProcess(3,meta,block*IO_BLOCKSIZE+offset,address,count);return}}address+=2;count-=2;offset+=2;break;case 2:data=(meta.cache[block][offset+1]<<8)|meta.cache[block][offset];if(count>1){if(writeWordByPhysical((meta.mapped?mapUnibus(address):address),data)<0){meta.postProcess(2,meta,block*IO_BLOCKSIZE+offset,address,count);return}address+=2;count-=2}else{if(writeByteByPhysical((meta.mapped?mapUnibus(address):address),data&0xff)<0){meta.postProcess(2,meta,block*IO_BLOCKSIZE+offset,address,count);return}address+=1;--count}offset+=2;break;case 4:data=(meta.cache[block][offset+1]<<8)|meta.cache[block][offset];address=(data<<16)|(address>>>16);count-=2;offset+=2;break;case 5:address=meta.cache[block][offset++];count=0;break;default:panic()}if(offset>=IO_BLOCKSIZE){offset=0;block++;if(typeof meta.cache[block]==="undefined")break}}position=block*IO_BLOCKSIZE+offset}if(count>0){if(typeof meta.xhr==="undefined"){meta.xhr=new XMLHttpRequest()}meta.xhr.open("GET",meta.url,true);meta.xhr.responseType="arraybuffer";meta.xhr.onreadystatechange=function(){if(meta.xhr.readyState===meta.xhr.DONE){getData(meta.xhr,operation,meta,position,address,count)}};block=~~(position/IO_BLOCKSIZE);meta.xhr.setRequestHeader("Range","bytes="+(block*IO_BLOCKSIZE)+"-"+((block+1)*IO_BLOCKSIZE-1));meta.xhr.send(null);return}meta.postProcess(0,meta,position,address,count)}var rk11={rkds:0o4700,rker:0,rkcs:0o200,rkwc:0,rkba:0,rkda:0,meta:[],TRACKS:[406,406,406,406,406,406,406,0],SECTORS:[12,12,12,12,12,12,12,12]};function rk11_init(){rk11.rkds=0o4700;rk11.rker=0;rk11.rkcs=0o200;rk11.rkwc=0;rk11.rkba=0;rk11.rkda=0}function rk11_seekEnd(drive){rk11.rkds=(drive<<13)|(rk11.rkds&0x1ff0);rk11.rkcs|=0x2000;return rk11.rkcs&0x40}function rk11_commandEnd(drive){rk11.rkds=(drive<<13)|(rk11.rkds&0x1ff0);rk11.rkcs|=0x80;return rk11.rkcs&0x40}function rk11_end(err,meta,position,address,count){rk11.rkba=address&0xffff;rk11.rkcs=(rk11.rkcs&~0x30)|((address>>>12)&0x30);rk11.rkcs|=0x2000;rk11.rkwc=(0x10000-(count>>>1))&0xffff;position=~~(position/512);rk11.rkda=(rk11.rkda&0xe000)|((~~(position/rk11.SECTORS[meta.drive]))<<4)|(position%rk11.SECTORS[meta.drive]);switch(err){case 1:rk11.rker|=0x8100;rk11.rkcs|=0xc000;if(rk11.rker&0x7fc0)rk11.rkcs|=0x4000;break;case 2:rk11.rker|=0x8400;rk11.rkcs|=0xc000;break;case 3:rk11.rker|=0x8001;rk11.rkcs|=0x8000;break}interrupt(10,5<<5,0o220,0,rk11_commandEnd,meta.drive)}function rk11_go(){var sector,address,count;var drive=(rk11.rkda>>>13)&7;if(typeof rk11.meta[drive]==="undefined"){rk11.meta[drive]={"cache":[],"postProcess":rk11_end,"drive":drive,"mapped":1,"maxblock":rk11.TRACKS[drive]*rk11.SECTORS[drive],"url":"rk"+drive+".dsk"}}if(rk11.TRACKS[drive]===0){rk11.rker|=0x8080}else{switch((rk11.rkcs>>>1)&7){case 0:interrupt(-1,5<<5,0o220,-1);for(var i=0;i<8;i++){if(typeof rk11.meta[drive]!=="undefined"){if(typeof rk11.meta[drive].xhr!=="undefined"){rk11.meta[drive].xhr.abort()}}}rk11_init();break;case 1:case 2:case 3:if(((rk11.rkda>>>4)&0x1ff)>=rk11.TRACKS[drive]){rk11.rker|=0x8040;break}if((rk11.rkda&0xf)>=rk11.SECTORS[drive]){rk11.rker|=0x8020;break}rk11.rkcs&=~0x2000;sector=(((rk11.rkda>>>4)&0x1ff)*rk11.SECTORS[drive]+(rk11.rkda&0xf));address=(((rk11.rkcs&0x30))<<12)|rk11.rkba;count=(0x10000-rk11.rkwc)&0xffff;diskIO((rk11.rkcs>>>1)&7,rk11.meta[drive],sector*512,address,count<<1);return;case 6:rk11.rker=0;rk11.rkda&=0xe000;case 4:rk11.rkcs&=~0x2000;rk11.rkcs|=0x80;interrupt(64,5<<5,0o220,64+drive,rk11_seekEnd,drive);break;case 5:break;case 7:break;default:break}}interrupt(10,5<<5,0o220,0,rk11_commandEnd,drive);return 0}function accessRK11(physicalAddress,data,byteFlag){var result;switch(physicalAddress&~1){case 0o17777400:result=rk11.rkds;break;case 0o17777402:result=rk11.rker;break;case 0o17777404:result=insertData(rk11.rkcs,physicalAddress,data,byteFlag);if(data>=0&&result>=0){if((rk11.rkcs^result)&0x40){if((result&0x40)){}}rk11.rkcs=(result&~0xf080)|(rk11.rkcs&0xf080);if((rk11.rkcs&0x81)===0x81){rk11.rkcs&=~0x81;rk11.rker&=~0x03;setTimeout(rk11_go,0)}}break;case 0o17777406:result=insertData(rk11.rkwc,physicalAddress,data,byteFlag);if(result>=0)rk11.rkwc=result;break;case 0o17777410:result=insertData(rk11.rkba,physicalAddress,data,byteFlag);if(result>=0)rk11.rkba=result;break;case 0o17777412:result=insertData(rk11.rkda,physicalAddress,data,byteFlag);if(result>=0)rk11.rkda=result;break;case 0o17777414:case 0o17777416:result=0;break;default:CPU.CPU_Error|=0x10;return trap(4,202)}return result}var rl11={csr:0x81,bar:0,dar:0,mpr:0,DAR:0,meta:[],SECTORS:[40,40,40,40],TRACKS:[1024,1024,512,512],STATUS:[0235,0o235,035,035]};function rl11_commandEnd(){rl11.csr|=0x81;return rl11.csr&0x40}function rl11_finish(drive){if(rl11.csr&0x40){interrupt(10,5<<5,0160,rl11_commandEnd,0)}else{rl11_commandEnd()}}function rl11_go(){var sector,address,count;var drive=(rl11.csr>>>8)&3;rl11.csr&=~0x1;if(typeof rl11.meta[drive]==="undefined"){rl11.meta[drive]={"cache":[],"postProcess":rl11_end,"drive":drive,"mapped":1,"maxblock":rl11.TRACKS[drive]*rl11.SECTORS[drive],"url":"rl"+drive+".dsk"}}switch((rl11.csr>>>1)&7){case 0:break;case 1:break;case 2:if(rl11.mpr&8)rl11.csr&=0x3f;rl11.mpr=rl11.STATUS[drive]|(rl11.DAR&0100);break;case 3:if((rl11.dar&3)===1){if(rl11.dar&4){rl11.DAR=((rl11.DAR+(rl11.dar&0xff80))&0xff80)|((rl11.dar<<2)&0x40)}else{rl11.DAR=((rl11.DAR-(rl11.dar&0xff80))&0xff80)|((rl11.dar<<2)&0x40)}rl11.dar=rl11.DAR}break;case 4:rl11.mpr=rl11.DAR;break;case 5:if((rl11.dar>>>6)>=rl11.TRACKS[drive]){rl11.csr|=0x9400;break}if((rl11.dar&0x3f)>=rl11.SECTORS[drive]){rl11.csr|=0x9400;break}sector=((rl11.dar>>>6)*rl11.SECTORS[drive])+(rl11.dar&0x3f);address=rl11.bar|((rl11.csr&0x30)<<12);count=(0x10000-rl11.mpr)&0xffff;diskIO(1,rl11.meta[drive],sector*256,address,count<<1);return;break;case 6:case 7:if((rl11.dar>>>6)>=rl11.TRACKS[drive]){rl11.csr|=0x9400;break}if((rl11.dar&0x3f)>=rl11.SECTORS[drive]){rl11.csr|=0x9400;break}sector=((rl11.dar>>>6)*rl11.SECTORS[drive])+(rl11.dar&0x3f);address=rl11.bar|((rl11.csr&0x30)<<12);count=(0x10000-rl11.mpr)&0xffff;diskIO(2,rl11.meta[drive],sector*256,address,count<<1);return;break}rl11_finish()}function rl11_end(err,meta,position,address,count){var sector=~~(position/256);rl11.bar=address&0xffff;rl11.csr=(rl11.csr&~0x30)|((address>>>12)&0x30);rl11.dar=((~~(sector/rl11.SECTORS[meta.drive]))<<6)|(sector%rl11.SECTORS[meta.drive]);rl11.DAR=rl11.dar;rl11.mpr=(0x10000-(count>>>1))&0xffff;switch(err){case 1:rl11.csr|=0x8400;break;case 2:rl11.csr|=0xa000;break}rl11_finish()}function accessRL11(physicalAddress,data,byteFlag){var result;switch(physicalAddress&~1){case 0o17774400:result=insertData(rl11.csr,physicalAddress,data,byteFlag);if(data>=0&&result>=0){if((rl11.csr&0x40)&&!(result&0x40)){interrupt(-1,5<<5,0o160,0)}if(!(result&0x80)){rl11.csr=(rl11.csr&~0x3fe)|(result&0x3fe);rl11_go()}else{if((result&0x40)&&!(rl11.csr&0x40)){interrupt(10,5<<5,0o160,0)}rl11.csr=(rl11.csr&~0x3fe)|(result&0x3fe)}}break;case 0o17774402:result=insertData(rl11.bar,physicalAddress,data,byteFlag);if(result>=0){rl11.bar=result&0xfffe}break;case 0o17774404:result=insertData(rl11.dar,physicalAddress,data,byteFlag);if(result>=0)rl11.dar=result;break;case 0o17774406:result=insertData(rl11.mpr,physicalAddress,data,byteFlag);if(result>=0)rl11.mpr=result;break;default:CPU.CPU_Error|=0x10;return trap(4,204)}return result}var rp11={DTYPE:[020022,0o20022,0o20020,0o20020,0o20020,0o20020,0o20022,0o20042],SECTORS:[22,22,22,22,22,22,22,50],SURFACES:[19,19,19,19,19,19,19,32],CYLINDERS:[815,815,815,815,815,411,815,630],meta:[],rpcs1:0x880,rpwc:0,rpba:0,rpda:[0,0,0,0,0,0,0,0],rpcs2:0,rpds:[0x1180,0x1180,0x1180,0x1180,0x1180,0,0,0],rper1:[0,0,0,0,0,0,0,0],rpla:[0,0,0,0,0,0,0,0],rpdb:0,rpmr:[0,0,0,0,0,0,0,0],rpdt:[0,0,0,0,0,0,0,0],rpsn:[1,2,3,4,5,6,7,8],rpof:[0,0,0,0,0,0,0,0],rpdc:[0,0,0,0,0,0,0,0],rpcc:[0,0,0,0,0,0,0,0],rper2:[0,0,0,0,0,0,0,0],rper3:[0,0,0,0,0,0,0,0],rpec1:[0,0,0,0,0,0,0,0],rpec2:[0,0,0,0,0,0,0,0],rpcs3:0};function rp11_init(){rp11.rpcs1=0x880;rp11.rpcs2=0;rp11.rpds=[0x11c0,0x11c0,0x11c0,0x11c0,0x11c0,0,0,0];rp11.rpda=[0,0,0,0,0,0,0,0];rp11.rpdc=[0,0,0,0,0,0,0,0];rp11.rper1=[0,0,0,0,0,0,0,0];rp11.rper3=[0,0,0,0,0,0,0,0];rp11.rpas=rp11.rpwc=rp11.rpcs3=0;rp11.rpba=0}function rp11_go(){var sector,drive=rp11.rpcs2&7;rp11.rpds[drive]&=0x7fff;if(typeof rp11.meta[drive]==="undefined"){rp11.meta[drive]={"cache":[],"postProcess":rp11_end,"drive":drive,"mapped":0,"maxblock":rp11.CYLINDERS[drive]*rp11.SURFACES[drive]*rp11.SECTORS[drive],"url":"rp"+drive+".dsk"}}switch(rp11.rpcs1&0x3f){case 0o1:return;case 0o3:break;case 0o5:break;case 0o7:break;case 0o11:rp11.rpds[drive]=0x11c0;rp11.rpcs1&=~0x703f;rp11.rpda[drive]=0;rp11.rpdc[drive]=0;rp11.rpcs1=0x880;return;case 0o13:return;case 0o15:break;case 0o17:break;case 0o21:rp11.rpdc[drive]=rp11.rpda[drive]=0;rp11.rpds[drive]=0x11c0;rp11.rpof[drive]=0;return;case 0o23:rp11.rpds[drive]|=0x40;return;case 0o31:break;case 0o61:if(rp11.rpdc[drive]>=rp11.CYLINDERS[drive]||(rp11.rpda[drive]>>>8)>=rp11.SURFACES[drive]||(rp11.rpda[drive]&0xff)>=rp11.SECTORS[drive]){rp11.rper1[drive]|=0x400;rp11.rpcs1|=0xc000;break}rp11.rpcs1&=~0x7000;rp11.rpcs1&=~0x4080;rp11.rpcs2&=~0x800;rp11.rpds[drive]&=~0x480;sector=(rp11.rpdc[drive]*rp11.SURFACES[drive]+(rp11.rpda[drive]>>>8))*rp11.SECTORS[drive]+(rp11.rpda[drive]&0xff);diskIO(1,rp11.meta[drive],sector*512,rp11.rpba,((0x10000-rp11.rpwc)&0xffff)<<1);return;break;case 0o71:if(rp11.rpdc[drive]>=rp11.CYLINDERS[drive]||(rp11.rpda[drive]>>>8)>=rp11.SURFACES[drive]||(rp11.rpda[drive]&0xff)>=rp11.SECTORS[drive]){rp11.rper1[drive]|=0x400;rp11.rpcs1|=0xc000;break}rp11.rpcs1&=~0x7000;rp11.rpcs1&=~0x4080;rp11.rpcs2&=~0x800;rp11.rpds[drive]&=~0x480;sector=(rp11.rpdc[drive]*rp11.SURFACES[drive]+(rp11.rpda[drive]>>>8))*rp11.SECTORS[drive]+(rp11.rpda[drive]&0xff);diskIO(2,rp11.meta[drive],sector*512,rp11.rpba,((0x10000-rp11.rpwc)&0xffff)<<1);return;break;default:panic();return;break}interrupt(12,5<<5,0o254,0,function(){rp11.rpds[drive]|=0x8000;rp11.rpcs1|=0x8000;if(rp11.rpcs1&0x40)return true;return false})}function rp11_end(err,meta,position,address,count){var sector,block=~~((position+511)/512);rp11.rpwc=(0x10000-(count>>>1))&0xffff;rp11.rpba=address&0x3fffff;sector=~~(block/rp11.SECTORS[meta.drive]);rp11.rpda[meta.drive]=((sector%rp11.SURFACES[meta.drive])<<8)|(block%rp11.SECTORS[meta.drive]);rp11.rpdc[meta.drive]=~~(sector/rp11.SURFACES[meta.drive]);if(block>=meta.maxblock){rp11.rpds[meta.drive]|=0x400}if(err){rp11.rpds[meta.drive]|=0x8000;rp11.rpcs1|=0xc000;switch(err){case 1:rp11.rpcs2|=0x200;break;case 2:rp11.rpcs2|=0x800;break}}interrupt(20,5<<5,0o254,0,function(){rp11.rpds[meta.drive]|=0x80;rp11.rpcs1|=0x80;if(rp11.rpcs1&0x40)return true;return false})}function accessRP11(physicalAddress,data,byteFlag){var idx,result;idx=rp11.rpcs2&7;switch(physicalAddress&~1){case 0o17776700:result=(rp11.rpcs1&~0xb01)|((rp11.rpba>>>8)&0x300);if(rp11.rpds[idx]&0x100){result|=0x800;if(!(rp11.rpcs1&0x80))result|=1}else{result&=0xff7f}rp11.rpcs1=result;if(data>=0){result=insertData(result,physicalAddress,data,byteFlag);if(result>=0){rp11.rpba=(rp11.rpba&0x3cffff)|((result<<8)&0x30000);result=(result&~0xb880)|(rp11.rpcs1&0xb880);if(!(result&0x40))interrupt(-1,0,0o254,0);if((data&0xc0)===0xc0)interrupt(8,5<<5,0o254,0);rp11.rpcs1=result;if(result&1&&(rp11.rpcs1&0x80)){rp11_go()}}}break;case 0o17776702:result=insertData(rp11.rpwc,physicalAddress,data,byteFlag);if(result>=0)rp11.rpwc=result;break;case 0o17776704:result=rp11.rpba&0xffff;if(data>=0){result=insertData(result,physicalAddress,data,byteFlag);if(result>=0){rp11.rpba=(rp11.rpba&0x3f0000)|(result&0xfffe)}}break;case 0o17776710:result=rp11.rpcs2;if(data>=0){result=insertData(result,physicalAddress,data,byteFlag);if(result>=0){rp11.rpcs2=(result&0x3f)|(rp11.rpcs2&0xffc0);if(result&0x20)rp11_init()}}break;case 0o17776716:result=0;for(idx=0;idx<8;idx++){if(rp11.rpds[idx]&0x8000){if(data>=0&&(data&(1<<idx))){rp11.rpds[idx]&=0x7fff}else{result|=1<<idx}}}if(data>0)rp11.rpcs1&=0x7fff;break;case 0o17776722:result=0;break;case 0o17776750:result=(rp11.rpba>>>16)&0x3f;if(data>=0){result=insertData(result,physicalAddress,data,byteFlag);if(result>=0){rp11.rpba=((result&0x3f)<<16)|(rp11.rpba&0xffff)}}break;case 0o17776752:result=0;break;default:idx=rp11.rpcs2&7;if(rp11.rpds[idx]&0x100){switch(physicalAddress&~1){case 0o17776706:result=insertData(rp11.rpda[idx],physicalAddress,data,byteFlag);if(result>=0)rp11.rpda[idx]=result&0x1f1f;break;case 0o17776712:result=rp11.rpds[idx];break;case 0o17776714:result=0;break;case 0o17776720:result=0;break;case 0o17776724:result=0;break;case 0o17776726:result=rp11.DTYPE[idx];break;case 0o17776730:result=idx+1;break;case 0o17776732:result=insertData(rp11.rpof[idx],physicalAddress,data,byteFlag);if(result>=0)rp11.rpof[idx]=result;break;case 0o17776734:result=insertData(rp11.rpdc[idx],physicalAddress,data,byteFlag);if(result>=0)rp11.rpdc[idx]=result&0x3ff;break;case 0o17776736:result=rp11.rpdc[idx];break;case 0o17776740:result=0;break;case 0o17776742:result=0;break;case 0o17776744:result=0;break;case 0o17776746:result=0;break;default:CPU.CPU_Error|=0x10;return trap(4,206)}}else{rp11.rpcs2|=0x1000;rp11.rpcs1|=0xc000;if(rp11.rpcs1&0x40){interrupt(5,5<<5,0o254,0)}result=0}}return result}var tm11={mts:0x65,mtc:0x6080,mtbrc:0,mtcma:0,mtd:0,mtrd:0,meta:[]};function tm11_commandEnd(){tm11.mts|=1;tm11.mtc|=0x80;return tm11.mtc&0x40}function tm11_finish(){if(tm11.mtc&0x40){interrupt(10,5<<5,0o224,0,tm11_commandEnd)}else{tm11_commandEnd()}}function tm11_end(err,meta,position,address,count){if(err===0&&meta.command>0){if(address===0||address>0x80000000){meta.position=(position+1)&~1;tm11.mts|=0x4000}else{switch(meta.command){case 1:meta.position=(position+4+address+1)&~1;meta.command=0;count=(0x10000-tm11.mtbrc)&0xffff;if(count>=address||count===0){count=address;tm11.mtbrc=(tm11.mtbrc+count)&0xffff}else{tm11.mts|=0x200;tm11.mtbrc=0}address=((tm11.mtc&0x30)<<12)|tm11.mtcma;diskIO(2,meta,position,address,count);return;case 4:position=(position+4+address+1)&~1;meta.position=position;tm11.mtbrc=(tm11.mtbrc+1)&0xffff;if(tm11.mtbrc){diskIO(4,meta,position,0,4);return}break;case 5:position=(position-8-address+1)&~1;meta.position=position;tm11.mtbrc=(tm11.mtbrc+1)&0xffff;if(tm11.mtbrc){if(position>0){diskIO(4,meta,position-4,0,4);return}}break;default:panic()}}}if(meta.command===0){tm11.mtbrc=(tm11.mtbrc-count)&0xffff;tm11.mtcma=address&0xffff;tm11.mtc=(tm11.mtc&~0x30)|((address>>>12)&0x30)}switch(err){case 1:tm11.mts|=0x100;break;case 2:tm11.mts|=0x80;break}tm11_finish()}function tm11_init(){var i;tm11.mts=0x65;tm11.mtc=0x6080;for(i=0;i<8;i++){if(typeof tm11.meta[i]!=="undefined"){tm11.meta[i].position===0}}}function tm11_go(){var drive=(tm11.mtc>>>8)&3;tm11.mtc&=~0x81;tm11.mts&=0x04fe;if(typeof tm11.meta[drive]==="undefined"){tm11.meta[drive]={"cache":[],"postProcess":tm11_end,"drive":drive,"mapped":1,"maxblock":0,"position":0,"command":0,"url":"tm"+drive+".tap"}}tm11.meta[drive].command=(tm11.mtc>>>1)&7;switch(tm11.meta[drive].command){case 0:break;case 1:diskIO(4,tm11.meta[drive],tm11.meta[drive].position,0,4);return;case 2:case 3:case 6:break;case 4:diskIO(4,tm11.meta[drive],tm11.meta[drive].position,0,4);return;case 5:if(tm11.meta[drive].position>0){diskIO(4,tm11.meta[drive],tm11.meta[drive].position-4,0,4);return}break;case 7:tm11.meta[drive].position=0;tm11.mts|=0x20;break;default:break}tm11_finish()}function accessTM11(physicalAddress,data,byteFlag){var result;switch(physicalAddress&~1){case 0o17772520:tm11.mts&=~0x20;if(typeof tm11.meta[(tm11.mtc>>>8)&3]!=="undefined"){if(tm11.meta[(tm11.mtc>>>8)&3].position===0){tm11.mts|=0x20}}result=tm11.mts;break;case 0o17772522:tm11.mtc&=0x7fff;if(tm11.mts&0xff80)tm11.mtc|=0x8000;result=insertData(tm11.mtc,physicalAddress,data,byteFlag);if(data>=0&&result>=0){if((tm11.mtc&0x40)&&!(result&0x40)){interrupt(-1,5<<5,0o224,-1)}if(result&0x1000){tm11.mts=0x65;tm11.mtc=0x6080}if((tm11.mtc&0x80)&&(result&0x1)){tm11.mtc=(tm11.mtc&0x80)|(result&0xff7f);tm11_go()}else{if((result&0x40)&&(tm11.mtc&0xc0)===0x80){interrupt(10,5<<5,0o224,0)}tm11.mtc=(tm11.mtc&0x80)|(result&0xff7f)}}break;case 0o17772524:result=insertData(tm11.mtbrc,physicalAddress,data,byteFlag);if(result>=0)tm11.mtbrc=result;break;case 0o17772526:result=insertData(tm11.mtcma,physicalAddress,data,byteFlag);if(result>=0)tm11.mtcma=result;break;case 0o17772530:case 0o17772532:result=0;break;default:CPU.CPU_Error|=0x10;return trap(4,208)}return result}var ptr11={prs:0,pdb:0,name:""};function ptr11_init(){ptr11.prs=0;ptr11.name=document.getElementById("ptr").value;if(ptr11.name===""){ptr11.prs=0x8000}if(typeof ptr11.meta!=="undefined"){delete ptr11.meta}}function ptr11_end(err,meta,position,address,count){meta.position=position;ptr11.pdb=address&0xff;ptr11.prs&=~0x800;if(ptr11.prs&0x40){interrupt(6,4<<5,0o70,0)}if(err===0){ptr11.prs|=0x80}else{ptr11.prs|=0x8000}}function accessPTR11(physicalAddress,data,byteFlag){var result;switch(physicalAddress&6){case 0:result=insertData(ptr11.prs,physicalAddress,data,byteFlag);if(result>=0&&data>0){if((result&0x40)&&!(ptr11.prs&0x40)&&(ptr11.prs&0x8080)){interrupt(6,4<<5,0o70,0)}if(!(ptr11.prs&0x8800)&&(result&1)){if(typeof ptr11.meta==="undefined"){ptr11.meta={"cache":[],"postProcess":ptr11_end,"mapped":0,"position":0,"url":ptr11.name}}ptr11.prs=(ptr11.prs&~0xc0)|(result&0x40)|0x800;result=ptr11.prs;diskIO(5,ptr11.meta,ptr11.meta.position,017777552,1)}}break;case 2:result=insertData(ptr11.pdb,physicalAddress,data,byteFlag);ptr11.prs=ptr11.prs&~0x80}return result}var lp11={lpcs:0,lpdb:0};function lp11_init(){lp11.lpcs=0x80}function lp11_initialize(){document.getElementById("lp11").innerHTML='<p>printer<br /><textarea id=lp11_id cols=132 rows=24 spellcheck=false style="font-family:Liberation Mono,Monaco,Courier New,Lucida Console,Consolas,DejaVu Sans Mono,Bitstream Vera Sans Mono,monospace"></textarea><br /><button onclick="document.getElementById('+"'lp11_id'"+').value='+"''"+';">Clear</button></p>';lp11.textElement=document.getElementById("lp11_id")}var DL11=[];function dl11_reset(){"use strict";var i;for(i=0;i<DL11.length;i++){DL11[i].rcsr=0;DL11[i].xcsr=0x80;vt52Reset(i)}}function dl11_initialize(unit,vector){"use strict";var divElement;if(unit!==0){divElement=document.createElement('div');divElement.innerHTML='<p>tty'+unit+'<br /><textarea id='+unit+' cols=132 rows=24 style="font-family:'+"'Courier New'"+',Courier,'+"'Lucida Console'"+',Monaco,monospace;" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"></textarea><br /></p>';document.getElementById('dl11').appendChild(divElement)}DL11[unit]={rcsr:0,rbuf:0,xcsr:0x80,xbuf:0,vector:vector};vt52Initialize(unit,document.getElementById(unit),dl11Input)}function dl11Input(unit,ch){"use strict";if(DL11[unit].rcsr&0x80){return 0}DL11[unit].rbuf=ch;DL11[unit].rcsr|=0x80;if(DL11[unit].rcsr&0x40){interrupt(4,4<<5,DL11[unit].vector,0)}return 1}function accessDL11(physicalAddress,data,byteFlag,unit,vector){"use strict";var result=0;if(typeof DL11[unit]==="undefined"){dl11_initialize(unit,vector)}switch(physicalAddress&0x6){case 6:result=insertData(DL11[unit].xbuf,physicalAddress,data,byteFlag);if(data>=0&&result>=0){DL11[unit].xbuf=result;result&=0x7f;if(result>=8&&result<127){vt52Put(unit,result)}if(DL11[unit].xcsr&0x40){interrupt(4,4<<5,DL11[unit].vector+4,0)}}break;case 4:result=insertData(DL11[unit].xcsr,physicalAddress,data,byteFlag);if(data>=0&&result>=0){if(((DL11[unit].xcsr^result)&0x40)){if(result&0x40){DL11[unit].xcsr=0xc0;interrupt(5,4<<5,DL11[unit].vector+4,0)}else{DL11[unit].xcsr&=0x80;interrupt(-1,4<<5,DL11[unit].vector+4,-1)}}}break;case 2:result=insertData(DL11[unit].rbuf,physicalAddress,data,byteFlag);if(result>=0&&data<0){DL11[unit].rcsr&=~0x80}break;case 0:result=insertData(DL11[unit].rcsr,physicalAddress,data,byteFlag);if(result>=0&&data>=0){if((DL11[unit].rcsr&0x40)&&!(result&0x40)){interrupt(-1,4<<5,DL11[unit].vector,-1)}DL11[unit].rcsr=(DL11[unit].rcsr&0x80)|(result&0x40)}break}return result}var kw11={csr:0,timerId:null,interruptTime:0};function kw11_init(){"use strict";kw11.csr=0x80;if(kw11.timerId===null){kw11.timerId=setTimeout(kw11_interrupt,20)}}function kw11_interrupt(){"use strict";var timeNow=Date.now();kw11.interruptTime+=20;if(timeNow-kw11.interruptTime>30000){kw11.interruptTime=timeNow+20}setTimeout(kw11_interrupt,Math.max(0,kw11.interruptTime-timeNow));if(CPU.runState!==STATE_HALT){kw11.csr|=0x80;if(kw11.csr&0x40){interrupt(0,6<<5,0o100,0)}}}function reset_iopage(){"use strict";CPU.PIR=0;CPU.stackLimit=0xff;CPU.CPU_Error=0;CPU.interruptQueue=[];CPU.MMR0=CPU.MMR3=CPU.mmuEnable=0;CPU.MMR3Mask[0]=CPU.MMR3Mask[1]=CPU.MMR3Mask[3]=7;CPU.mmuLastPage=0;dl11_reset();ptr11_init();lp11_init();kw11_init();rk11_init();rl11.csr=0x80;rp11_init();tm11_init()}function mapUnibus(unibusAddress){"use strict";var idx=(unibusAddress>>>13)&0x1f;if(idx<31){if(CPU.MMR3&0x20){unibusAddress=(CPU.unibusMap[idx]+(unibusAddress&0x1fff))&0x3fffff}}else{unibusAddress|=IOBASE_22BIT}return unibusAddress}function insertData(original,physicalAddress,data,byteFlag){"use strict";if(physicalAddress&1){if(!byteFlag){return trap(4,212)}if(data>=0){data=((data<<8)&0xff00)|(original&0xff)}else{data=original}}else{if(data>=0){if(byteFlag){data=(original&0xff00)|(data&0xff)}}else{data=original}}return data}function access_iopage(physicalAddress,data,byteFlag){"use strict";var result,idx;switch(physicalAddress&~0o77){case 0o17777700:switch(physicalAddress&~1){case 0o17777776:result=insertData(readPSW(),physicalAddress,data,byteFlag);if(result>=0&&data>=0){writePSW(result);return-1}break;case 0o17777774:result=insertData(CPU.stackLimit,physicalAddress,data,byteFlag);if(result>=0){if(data>=0){CPU.stackLimit=result|0xff}result&=0xff00}break;case 0o17777772:result=insertData(CPU.PIR,physicalAddress,data,byteFlag);if(result>=0&&data>=0){result&=0xfe00;if(result){idx=result>>>9;do{result+=0x22}while(idx>>=1)}CPU.PIR=result;if((result&0xe0)>(CPU.PSW&0xe0)){CPU.priorityReview=1}}break;case 0o17777766:if(CPU.cpuType!==70){result=trap(4,214)}else{result=insertData(CPU.CPU_Error,physicalAddress,data,byteFlag);if(result>=0&&data>=0){result=CPU.CPU_Error=0}}break;case 0o17777764:if(CPU.cpuType!==70){result=trap(4,218)}else{result=insertData(1,physicalAddress,data,byteFlag)}break;case 0o17777762:if(CPU.cpuType!==70){result=trap(4,222)}else{result=insertData(0,physicalAddress,data,byteFlag)}break;case 0o17777760:if(CPU.cpuType!==70){result=trap(4,224)}else{result=insertData((MAX_MEMORY>>>6)-1,physicalAddress,data,byteFlag)}break;case 0o17777770:if(data>=0&&!(physicalAddress&1))data&=0xff;case 0o17777756:case 0o17777754:case 0o17777752:case 0o17777750:case 0o17777746:case 0o17777744:case 0o17777742:case 0o17777740:if(CPU.cpuType!==70){result=trap(4,228)}else{idx=(physicalAddress-0o17777740)>>>1;result=insertData(CPU.controlReg[idx],physicalAddress,data,byteFlag);if(result>=0){if((physicalAddress&1)===0o17777746)result=0o17;if((physicalAddress&1)===0o17777742)result=0o3;if((physicalAddress&1)===0o17777740)result=0o177740;CPU.controlReg[idx]=result}}break;case 0o17777716:if(physicalAddress&1){if((CPU.PSW>>>14)&3===3){if(data>=0)CPU.registerVal[6]=data;result=CPU.registerVal[6]}else{if(data>=0)CPU.stackPointer[3]=data;result=CPU.stackPointer[3]}}else{if((CPU.PSW>>>14)&3===1){if(data>=0)CPU.registerVal[6]=data;result=CPU.registerVal[6]}else{if(data>=0)CPU.stackPointer[1]=data;result=CPU.stackPointer[1]}}return result;case 0o17777714:case 0o17777712:case 0o17777710:idx=physicalAddress&7;if(CPU.PSW&0x800){if(data>=0)CPU.registerVal[idx]=data;result=CPU.registerVal[idx]}else{if(data>=0)CPU.registerAlt[idx]=data;result=CPU.registerAlt[idx]}return result;case 0o17777706:if(physicalAddress&1){if(data>=0)CPU.registerVal[7]=data;result=CPU.registerVal[7]}else{if((CPU.PSW>>>14)&3===0){if(data>=0)CPU.registerVal[6]=data;result=CPU.registerVal[6]}else{if(data>=0)CPU.stackPointer[0]=data;result=CPU.stackPointer[0]}}return result;case 0o17777704:case 0o17777702:case 0o17777700:idx=physicalAddress&7;if(CPU.PSW&0x800){if(data>=0)CPU.registerAlt[idx]=data;result=CPU.registerAlt[idx]}else{if(data>=0)CPU.registerVal[idx]=data;result=CPU.registerVal[idx]}return result;default:CPU.CPU_Error|=0x10;result=trap(4,232)}break;case 0o17777600:idx=(physicalAddress>>>1)&0o37;if(idx<=15){result=insertData(CPU.mmuPDR[48|idx],physicalAddress,data,byteFlag);if(result>=0){CPU.mmuPDR[48|idx]=result&0xff0f}}else{idx&=0xf;result=insertData(CPU.mmuPAR[48|idx],physicalAddress,data,byteFlag);if(result>=0){CPU.mmuPAR[48|idx]=result;CPU.mmuPDR[48|idx]&=0xff0f}}break;case 0o17777500:switch(physicalAddress&~1){case 0o17777576:result=insertData(CPU.MMR2,physicalAddress,data,byteFlag);if(result>=0){CPU.MMR2=result}break;case 0o17777574:result=CPU.MMR1;if(result&0xff00)result=((result<<8)|(result>>>8))&0xffff;break;case 0o17777572:if(!(CPU.MMR0&0xe000)){CPU.MMR0=(CPU.MMR0&0xf381)|(CPU.mmuLastPage<<1)}result=insertData(CPU.MMR0,physicalAddress,data,byteFlag);if(result>=0&&data>=0){CPU.MMR0=result&=0xf381;CPU.mmuLastPage=(result>>>1)&0x3f;if(result&0x101){if(result&0x1){CPU.mmuEnable=MMU_READ|MMU_WRITE}else{CPU.mmuEnable=MMU_WRITE}}else{CPU.mmuEnable=0}}break;case 0o17777570:if(data<0){result=CPU.switchRegister&0xffff}else{result=insertData(CPU.displayRegister,physicalAddress,data,byteFlag);if(result>=0)CPU.displayRegister=result}break;case 0o17777566:case 0o17777564:case 0o17777562:case 0o17777560:result=accessDL11(physicalAddress,data,byteFlag,0,0o60);break;case 0o17777550:case 0o17777552:result=accessPTR11(physicalAddress,data,byteFlag);break;case 0o17777546:result=insertData(kw11.csr,physicalAddress,data,byteFlag);if(data>=0&&result>=0){result&=0x40;if((result^kw11.csr)&0x40){if(result&0x40){result|=0x80;interrupt(10,6<<5,0o100,0)}else{interrupt(-1,6<<5,0o100,-1)}}kw11.csr=result}break;case 0o17777516:result=insertData(lp11.lpdb,physicalAddress,data,byteFlag);if(data>=0&&result>=0){if(typeof lp11.textElement==="undefined"){lp11_initialize()}lp11.lpdb=result&0x7f;if(lp11.lpdb>=0o12&&lp11.lpdb!==0o15){lp11.textElement.value+=String.fromCharCode(lp11.lpdb)}if(lp11.lpcs&0x40){lp11.lpcs&=~0x80;interrupt(10,4<<5,0o200,0,function(){lp11.lpcs|=0x80;return(lp11.lpcs&0x40)})}}break;case 0o17777514:result=insertData(lp11.lpcs,physicalAddress,data,byteFlag);if(data>=0&&result>=0){if((result^lp11.lpcs)&0x40){if(result&0x40){lp11.lpcs=0xc0;interrupt(0,4<<5,0o200,0)}else{lp11.lpcs&=0x80}}}break;default:CPU.CPU_Error|=0x10;result=trap(4,234)}break;case 0o17777400:result=accessRK11(physicalAddress,data,byteFlag);break;case 0o17776700:if(physicalAddress<=0o17776753){result=accessRP11(physicalAddress,data,byteFlag)}else{if(typeof accessADCR!=='undefined'){result=accessADCR(physicalAddress,data,byteFlag)}else{CPU.CPU_Error|=0x10;result=trap(4,238)}}break;case 0o17776500:if(physicalAddress>=0o17776500&&physicalAddress<=0o17776527){idx=(physicalAddress-0o17776500)>>>3;result=accessDL11(physicalAddress,data,byteFlag,idx+1,idx*8+0o300)}else{CPU.CPU_Error|=0x10;result=trap(4,236)}break;case 0o17774400:result=accessRL11(physicalAddress,data,byteFlag);break;case 0o17772500:switch(physicalAddress&~1){case 0o17772516:result=insertData(CPU.MMR3,physicalAddress,data,byteFlag);if(result>=0&data>=0){if(CPU.cpuType!==70)result&=~0x30;CPU.MMR3=result;CPU.MMR3Mask[0]=7|((result&4)<<1);CPU.MMR3Mask[1]=7|((result&2)<<2);CPU.MMR3Mask[3]=7|((result&1)<<3)}break;default:result=accessTM11(physicalAddress,data,byteFlag);break}break;case 0o17772300:idx=(physicalAddress>>>1)&0o37;if(idx<=15){result=insertData(CPU.mmuPDR[0|idx],physicalAddress,data,byteFlag);if(result>=0){CPU.mmuPDR[0|idx]=result&0xff0f}}else{idx&=0xf;result=insertData(CPU.mmuPAR[0|idx],physicalAddress,data,byteFlag);if(result>=0){CPU.mmuPAR[0|idx]=result;CPU.mmuPDR[0|idx]&=0xff0f}}break;case 0o17772200:idx=(physicalAddress>>>1)&0o37;if(idx<=15){result=insertData(CPU.mmuPDR[16|idx],physicalAddress,data,byteFlag);if(result>=0){CPU.mmuPDR[16|idx]=result&0xff0f}}else{idx&=0xf;result=insertData(CPU.mmuPAR[16|idx],physicalAddress,data,byteFlag);if(result>=0){CPU.mmuPAR[16|idx]=result;CPU.mmuPDR[16|idx]&=0xff0f}}break;case 0o17772000:if(typeof accessVT11!=='undefined'){result=accessVT11(physicalAddress,data,byteFlag)}else{CPU.CPU_Error|=0x10;result=trap(4,242)}break;case 0o17770300:case 0o17770200:if(CPU.cpuType!==70){result=trap(4,244)}else{idx=(physicalAddress>>>2)&0x1f;result=CPU.unibusMap[idx];if(physicalAddress&0o2)result=(result>>>16)&0x803f;result=insertData(result&0xffff,physicalAddress,data,byteFlag);if(result>=0&&data>=0){if(physicalAddress&0o2){CPU.unibusMap[idx]=((result&0x803f)<<16)|(CPU.unibusMap[idx]&0xfffe)}else{CPU.unibusMap[idx]=(CPU.unibusMap[idx]&0x803f0000)|(result&0xfffe)}}}break;case 0o17767700:if(typeof accessVG11!=='undefined'){result=accessVG11(physicalAddress,data,byteFlag)}else{CPU.CPU_Error|=0x10;result=trap(4,246)}break;default:CPU.CPU_Error|=0x10;result=trap(4,248)}if(byteFlag&&result>=0){if((physicalAddress&1)){result=result>>>8}else{result&=0xff}}if(result<0){CPU.displayPhysical=-1;console.log("IOPAGE nxm failure "+physicalAddress.toString(8)+" "+data.toString(8)+" @"+CPU.registerVal[7].toString(8))}return result}

