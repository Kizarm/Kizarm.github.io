var vt11={stopInterrupt:0,penInterrupt:0,refreshOn:0,DPC:0,DSR:0x8000,XRegister:0,YRegister:0,graphIncrement:0,canvasFG:null,canvasBG:null,ctxFG:null,ctxBG:null,refreshDPC:0,refreshTime:0,blinkFlag:0,penX:0,penY:0,mouseX:0,mouseY:0,DEBUG:0};function vt11Initialize(){vt11.canvasFG=document.createElement('canvas');vt11.canvasFG.width=1024;vt11.canvasFG.height=768;vt11.canvasFG.style.border="1px solid";vt11.canvasFG.style.cursor="none";document.getElementById('vt11').appendChild(vt11.canvasFG);vt11.ctxFG=vt11.canvasFG.getContext("2d");vt11.canvasBG=document.createElement('canvas');vt11.canvasBG.width=1024;vt11.canvasBG.height=768;vt11.ctxBG=vt11.canvasBG.getContext('2d');vt11.canvasFG.addEventListener('mousemove',vt11TrackMouse,false);setInterval(vt11BlinkCycle,500)}function vt11TrackMouse(evt){var rect=vt11.canvasFG.getBoundingClientRect();vt11.mouseX=evt.clientX-rect.left,vt11.mouseY=evt.clientY-rect.top}function vt11BlinkCycle(){vt11.blinkFlag=1-vt11.blinkFlag}function vt11Read(physicalAddress){if(physicalAddress&1){CPU.CPU_Error|=0x40;return trap(4,26)}else{return readWordByPhysical(physicalAddress)}}function vt11PaintChar(ctx,code){if(code>=32&&code<=127){ctx.fillText(String.fromCharCode(code),vt11.XRegister,767-vt11.YRegister);vt11.XRegister+=8}else{switch(code){case 015:vt11.XRegister=0;break;case 012:vt11.YRegister-=10;if(vt11.YRegister<0)vt11.YRegister=0;break}}}function vt11Refresh(){if(vt11.refreshOn){vt11.ctxFG.clearRect(0,0,1024,768);vt11.ctxFG.beginPath();vt11.ctxFG.drawImage(vt11.canvasBG,0,0);if(!(vt11.DSR&0x80)){vt11.ctxFG.fillRect(vt11.mouseX,vt11.mouseY,3,2)}vt11.ctxBG.clearRect(0,0,1024,768);vt11.ctxBG.beginPath()}vt11.refreshDPC=vt11.DPC;vt11.refreshTime=Date.now()+800}function vt11DistanceCheck(x1,y1,x2,y2,p,q){var dx,dy;var dx=x1-p;var dy=y1-q;if(Math.sqrt(dx*dx+dy*dy)<8){vt11.penX=x1;vt11.penY=y1;return true}if(x1==x2&&y1==y2){return false}var dx=x2-p;var dy=y2-q;if(Math.sqrt(dx*dx+dy*dy)<8){vt11.penX=x2;vt11.penY=y2;return true}if((p<x1&&p<x2)||(p>x1&&p>x2)){return false}if((q<y1&&q<y2)||(q>y1&&q>y2)){return false}if(x1==x2){vt11.penX=x1;vt11.penY=q;return(Math.abs(p-x1)<8)}if(y1==y2){vt11.penX=p;vt11.penY=y1;return(Math.abs(q-y1)<8)}dx=x2-x1;dy=y2-y1;if((Math.abs(dy*p-dx*q+x2*y1-y2*x1)/Math.sqrt(dy*dy+dx*dx))<8){vt11.penX=p;vt11.penY=q;return true}return false}function vt11Execute(){var count,instruction,mode,intensify,style,penHit,XValue,YValue;if(vt11.ctxBG===null){vt11Initialize()}if(vt11.DPC==vt11.refreshDPC||vt11.refreshTime<Date.now()){vt11Refresh()}vt11.refreshOn=1;vt11.DSR&=~0x8000;for(count=0;count<8000;count++){if((instruction=vt11Read(vt11.DPC))>=0){vt11.DPC=(vt11.DPC+2)&0xffff;if(!(instruction&0x8000)){mode=(vt11.DSR>>11)&0xf;intensify=instruction&0x4000;if(vt11.DEBUG)console.log((vt11.DPC-2).toString(8)+" "+instruction.toString(8)+" Data mode "+mode.toString(2)+" I "+(intensify>>14)+" X "+vt11.XRegister+" Y "+vt11.YRegister);switch(mode){case 0:break;case 1:case 6:XValue=((instruction>>7)&0x3f);if(instruction&0x2000){XValue=vt11.XRegister-XValue}else{XValue=vt11.XRegister+XValue}YValue=(instruction&0x3f);if(instruction&0x40){YValue=vt11.YRegister-YValue}else{YValue=vt11.YRegister+YValue}break;case 2:case 3:XValue=(instruction&0x3ff);if(mode==2){if(instruction&0x2000){XValue=vt11.XRegister-XValue}else{XValue=vt11.XRegister+XValue}}if((instruction=vt11Read(vt11.DPC))>=0){vt11.DPC=(vt11.DPC+2)&0xffff;YValue=(instruction&0x3ff);if(mode==2){if(instruction&0x2000){YValue=vt11.YRegister-YValue}else{YValue=vt11.YRegister+YValue}}if(vt11.DEBUG)console.log((vt11.DPC-2).toString(8)+" "+instruction.toString(8)+" Extend "+" Xvalue "+XValue+" Yvalue "+YValue)}break;case 4:YValue=YRegister+vt11.graphIncrement;XValue=instruction&0x3ff;break;case 5:XValue=XRegister+vt11.graphIncrement;YValue=instruction&0x3ff;break}if(instruction>=0){penHit=0;if(!(vt11.DSR&0x8)||vt11.blinkFlag){if(mode==0){vt11PaintChar(vt11.ctxBG,instruction&0x7f);vt11PaintChar(vt11.ctxBG,(instruction>>8)&0x7f);if(vt11.DEBUG)console.log((vt11.DPC-2).toString(8)+" write text "+String.fromCharCode(instruction&0x7f,(instruction>>8)&0x7f))}else{if(intensify){style=((vt11.DSR>>7)&0xe).toString(16)+"0";vt11.ctxBG.beginPath();vt11.ctxBG.strokeStyle="#"+style+style+style;if(mode==3||mode==6){vt11.ctxFG.fillRect(XValue,767-YValue,1,1)}else{switch(vt11.DSR&0x3){case 0:vt11.ctxBG.setLineDash([]);break;case 1:vt11.ctxBG.setLineDash([8,8]);break;case 2:vt11.ctxBG.setLineDash([4,4]);break;case 3:vt11.ctxBG.setLineDash([2,2]);break}vt11.ctxBG.moveTo(vt11.XRegister,767-vt11.YRegister);vt11.ctxBG.lineTo(XValue,767-YValue);vt11.ctxBG.stroke()}if(vt11.penInterrupt){if(vt11DistanceCheck(vt11.XRegister,vt11.YRegister,XValue,YValue,vt11.mouseX,767-vt11.mouseY)){penHit=1}}}}}if(mode!=0){vt11.XRegister=XValue;vt11.YRegister=YValue}if(penHit){interrupt(0,4<<5,0o324,0);vt11.DSR|=0x8000;return}}}else{mode=(instruction>>11)&0xf;if(vt11.DEBUG)console.log((vt11.DPC-2).toString(8)+" "+instruction.toString(8)+" Control mode "+mode.toString(2));if(mode<=7){if(mode!=7){vt11.DSR=(vt11.DSR&0x87ff)|(instruction&0x7800)}if(instruction&0x400){vt11.DSR=(vt11.DSR&0xf8ff)|((instruction<<1)&0x700)}if(instruction&0x40){vt11.penInterrupt=(instruction&0x20)}if(instruction&0x10){vt11.DSR=(vt11.DSR&0xfff7)|(instruction&0x8)}if(instruction&4){vt11.DSR=(vt11.DSR&0xfffc)|(instruction&0x3)}}else{switch(mode){case 0xc:if((instruction=vt11Read(vt11.DPC))>=0){if(vt11.DEBUG)console.log((vt11.DPC).toString(8)+" "+instruction.toString(8)+" Jump to "+instruction.toString(8));vt11.DPC=instruction}break;case 0xe:if(instruction&0x200){vt11.stopInterrupt=instruction&0x100}if(instruction&0x80){vt11.DSR=(vt11.DSR&0xff7f)|((instruction<<1)&0x80)}if(instruction&0x20){instruction&0x10}if(instruction&0x404){if(instruction&0x4){vt11.refreshOn=0}instruction=-1}break;case 0xf:if(instruction&0x40){vt11.grphIncrement=instruction&0x3f}break}}}}if(instruction<0){break}}if(instruction>=0){setTimeout(vt11Execute,1);return}if(vt11.DEBUG)console.log((vt11.DPC).toString(8)+" **end** X "+vt11.XRegister+" Y "+vt11.YRegister);if(vt11.stopInterrupt){interrupt(20,4<<5,0o320,0)}vt11.DSR|=0x8000}function accessVT11(physicalAddress,data,byteFlag){var result;switch(physicalAddress&~1){case 017772000:result=insertData(vt11.DPC,physicalAddress,data,byteFlag);if(result>=0){if(data>=0&&result!=0){if(vt11.DEBUG)console.log((vt11.DPC).toString(8)+" **write to DPC** "+result.toString(8)+" X "+vt11.XRegister+" Y "+vt11.YRegister);if(!(result&1)){vt11.DPC=result}if((vt11.DSR&0x8000)){vt11Execute()}}}break;case 017772002:result=vt11.DSR;break;case 017772004:result=(vt11.penX&0x3ff)|((vt11.graphIncrement&0x2f)<<10);break;case 017772006:result=vt11.penY&0x3ff;break;default:CPU.CPU_Error|=0x10;return trap(4,134)}return result}

